# Maintainer: Robert Knauer <robert@privatdemail.net>

pkgname=c18h27no3-git
_pkgname=c18h27no3
pkgver=20121029
pkgrel=1
pkgdesc="A crazy game."
arch=('i686' 'x86_64')
url="https://github.com/rookies/${_pkgname}"
license=('GPL')
depends=('sfml' 'glibc' 'ttf-vollkorn')
makedepends=('git' 'cmake')

_gitroot="git://github.com/rookies/${_pkgname}.git"
_gitname="${_pkgname}"

build() {
  # Clone from git:
  cd "${srcdir}"
  msg "Connecting to GIT server...."
  if [[ -d "${_gitname}" ]]; then
    cd "${_gitname}" && git pull origin
    msg "The local files are updated."
  else
    git clone "${_gitroot}" "${_gitname}"
  fi
  msg "GIT checkout done or server timeout"
  msg "Starting build..."
  # Create build directory:
  rm -rf "${srcdir}/${_gitname}/build"
  mkdir "${srcdir}/${_gitname}/build"
  cd "${srcdir}/${_gitname}/build"
  # Run CMake:
  cmake -DCMAKE_INSTALL_PREFIX:string="/usr" ..
  # Build:
  make
  # Create language files:
  mkdir "locale"
  cd "${srcdir}/${_gitname}/locale"
  for _langf in *.po; do
    _lang=`echo $_langf | cut -d'.' -f1`
    msg "Compiling language file for [$_lang]... "
    if [[ ! -d "${srcdir}/${_gitname}/build/locale/$_lang" ]]; then
      mkdir "${srcdir}/${_gitname}/build/locale/$_lang" || exit 1
    fi
    if [[ ! -d "${srcdir}/${_gitname}/build/locale/$_lang/LC_MESSAGES" ]]; then
      mkdir "${srcdir}/${_gitname}/build/locale/$_lang/LC_MESSAGES" || exit 1
    fi
    msgfmt -o "${srcdir}/${_gitname}/build/locale/$_lang/LC_MESSAGES/${_pkgname}.mo" "$_langf"
  done
}

package() {
  cd "${srcdir}/${_gitname}/build"
  # Install:
  make DESTDIR="${pkgdir}" install
  # Install language files:
  for _f in locale/*; do
    install -m755 -Dd "${pkgdir}/usr/share/locale/`basename $_f`/LC_MESSAGES"
    install -m644 "$_f/LC_MESSAGES/${_pkgname}.mo" "${pkgdir}/usr/share/locale/`basename $_f`/LC_MESSAGES/"
  done
}
